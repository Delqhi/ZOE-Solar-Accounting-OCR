# ðŸ”„ N8N WORKFLOW - MASTER DEVELOPER LOOP
# **Automatisierte Task-Orchestrierung fÃ¼r Claude Code**
#
# Location: ~/.claude/N8N_WORKFLOW.yaml
# Import in n8n: n8n Dashboard â†’ Workflows â†’ Import

workflow:
  name: "Claude Master Developer Loop"
  description: "Vollautomatisierter Entwicklungskreislauf von Analyse bis Deployment"
  version: 1
  active: true

  # Trigger: Claude Code Webhook oder manueller Start
  trigger:
    type: "webhook"
    path: "/api/claude/master-loop"
    method: "POST"
    response: "Workflow gestartet"

    # Alternative: Zeitbasiert (z.B. alle 4 Stunden)
    # cron: "0 */4 * * *"

    # Alternative: GitHub Webhook (Push to main)
    # github: true

  # ==================== PHASE 1: ANALYSE & RECHERCHE ====================
  nodes:
    - id: 1
      name: "Phase 1: Analyse & Recherche"
      type: "function"
      description: "Serena MCP analysiert Kontext und recherchiert State-of-the-Art"
      code: |
        const { callMCP } = require('n8n-core');

        // Input von Claude oder Webhook
        const task = items[0].json.task || items[0].json.message;
        const project = items[0].json.project || 'current';

        // 1. Kontext-Analyse mit Serena
        const analysis = await callMCP('serena', 'analyze', {
          task: task,
          project_path: `/Users/jeremy/conductor/repos/${project}`,
          depth: 'full'
        });

        // 2. State-of-the-Art Recherche
        const research = await Promise.all([
          // GitHub API: Neueste Framework-Versionen
          fetch('https://api.github.com/search/repositories?q=supabase+connection+error+2026&sort=updated').then(r => r.json()),

          // Google Search (via SerpAPI)
          fetch('https://serpapi.com/search.json?q=ERR_CONNECTION_REFUSED+Supabase+2026&engine=google').then(r => r.json()),

          // Stack Overflow
          fetch('https://api.stackexchange.com/2.3/search/advanced?order=desc&sort=relevance&q=supabase+connection&site=stackoverflow').then(r => r.json())
        ]);

        // 3. Dokumentieren
        const timestamp = new Date().toISOString();
        const researchLog = `
## ${timestamp}
**Task:** ${task}
**Analysis:** ${analysis.summary}
**Research Results:**
- GitHub: ${research[0].items?.[0]?.html_url || 'No results'}
- Google: ${research[1].organic_results?.[0]?.link || 'No results'}
- StackOverflow: ${research[2].items?.[0]?.link || 'No results'}
`;

        // 4. Speichern
        await $node.helpers.writeFile(
          '/Users/jeremy/.claude/RESEARCH_LOG.md',
          researchLog,
          { append: true }
        );

        return [{
          json: {
            analysis,
            research,
            researchLog,
            next: 'plan'
          }
        }];

    # ==================== PHASE 2: PLANUNG ====================
    - id: 2
      name: "Phase 2: Task Planung"
      type: "function"
      description: "Erstellt Task-Queue und Implementation Plan"
      code: |
        const analysis = items[0].json.analysis;
        const research = items[0].json.research;

        // Generiere Task-Queue basierend auf Analyse
        const tasks = [
          {
            id: 1,
            name: "Enhanced Error Handling",
            agent: "code_agent",
            files: ["src/services/supabaseClient.ts", "src/services/monitoringService.tsx"],
            priority: "high",
            estimated_time: "15min"
          },
          {
            id: 2,
            name: "Diagnostics & Health Check",
            agent: "code_agent",
            files: ["check-supabase-connection.js", "SUPABASE_TROUBLESHOOTING.md"],
            priority: "medium",
            estimated_time: "10min"
          },
          {
            id: 3,
            name: "Global Infrastructure Setup",
            agent: "code_agent",
            files: ["~/.claude/GLOBAL_INFRASTRUCTURE.md"],
            priority: "low",
            estimated_time: "5min"
          },
          {
            id: 4,
            name: "Test & Validate",
            agent: "test_agent",
            tests: ["npm run test", "npm run build", "vercel deploy"],
            priority: "high",
            estimated_time: "10min"
          },
          {
            id: 5,
            name: "Monitor Deployment",
            agent: "monitor_agent",
            action: "skyvern_automation",
            priority: "high",
            estimated_time: "5min"
          }
        ];

        // Erstelle YAML
        const yaml = `# TASK QUEUE - Master Developer Loop
# Generated: ${new Date().toISOString()}
# Project: ${analysis.project || 'zoe-solar-accounting-ocr'}

tasks:
${tasks.map(t => `  - id: ${t.id}
    name: "${t.name}"
    agent: "${t.agent}"
    priority: "${t.priority}"
    estimated_time: "${t.estimated_time}"
    files: ${JSON.stringify(t.files || t.tests)}
    status: "pending"
    created_at: "${new Date().toISOString()}"
`).join('')}
`;

        // Speichern
        await $node.helpers.writeFile(
          '/Users/jeremy/.claude/TASK_QUEUE.yaml',
          yaml
        );

        return [{
          json: {
            tasks,
            yaml,
            next: 'execute'
          }
        }];

    # ==================== PHASE 3: CODE AGENT ====================
    - id: 3
      name: "Phase 3: Code Agent"
      type: "subworkflow"
      description: "FÃ¼hrt Code-Tasks aus mit Claude Code"
      workflowId: "code-agent-workflow"
      wait: true

    # ==================== PHASE 4: TEST & BUILD ====================
    - id: 4
      name: "Phase 4: Tests & Build"
      type: "exec"
      description: "FÃ¼hrt alle Tests und Build aus"
      command: |
        cd /Users/jeremy/conductor/repos/zoe-solar-accounting-ocr
        npm run lint
        npm run typecheck
        npm run test
        npm run build
      continueOnFail: false

    # ==================== PHASE 5: DEPLOYMENT ====================
    - id: 5
      name: "Phase 5: Git & Deploy"
      type: "exec"
      description: "Commit, Push und Vercel Deployment"
      command: |
        cd /Users/jeremy/conductor/repos/zoe-solar-accounting-ocr

        # Git Operations
        git add -A
        git commit -m "feat: Master Loop Auto-Deploy - $(date +%Y-%m-%d_%H-%M-%S)"
        git push origin main

        # Vercel Deploy
        vercel --prod --yes
      continueOnFail: true

    # ==================== PHASE 6: MONITORING ====================
    - id: 6
      name: "Phase 6: Skyvern Monitoring"
      type: "function"
      description: "Browser Automation fÃ¼r Monitoring & Logs"
      code: |
        const deployment = items[0].json.deployment || 'zoe-solar-accounting-ocr.vercel.app';

        // Rufe Skyvern MCP auf
        const monitoring = await $node.helpers.callMCP('skyvern', 'monitor', {
          url: `https://${deployment}`,
          actions: [
            'open_dashboard',
            'check_build_logs',
            'check_runtime_errors',
            'screenshot',
            'performance_metrics'
          ]
        });

        // Generiere Report
        const report = `# MONITORING REPORT
**Deployment:** ${deployment}
**Timestamp:** ${new Date().toISOString()}
**Status:** ${monitoring.errors.length === 0 ? 'âœ… HEALTHY' : 'âŒ ERRORS DETECTED'}

## Errors Found:
${monitoring.errors.map(e => `- ${e}`).join('\n')}

## Performance:
- Load Time: ${monitoring.performance?.loadTime || 'N/A'}
- FCP: ${monitoring.performance?.fcp || 'N/A'}

## Screenshots:
${monitoring.screenshots?.map(s => `![Screenshot](${s})`).join('\n') || 'No screenshots'}
`;

        // Speichern
        await $node.helpers.writeFile(
          '/Users/jeremy/.claude/MONITORING_REPORT.md',
          report
        );

        return [{
          json: {
            monitoring,
            report,
            has_errors: monitoring.errors.length > 0
          }
        }];

    # ==================== PHASE 7: FEEDBACK & ROLLBACK ====================
    - id: 7
      name: "Phase 7: Error Handling"
      type: "if"
      description: "PrÃ¼ft auf Fehler und initiiert Rollback oder Retry"
      condition: "has_errors == true"

      true:
        - id: 7.1
          name: "Rollback / Retry"
          type: "function"
          code: |
            // Auto-Rollback zu letztem Deployment
            const rollback = await $node.helpers.exec(
              'cd /Users/conductor/repos/zoe-solar-accounting-ocr && vercel --prod --target production'
            );

            // Slack Notification
            await $node.helpers.call('slack', {
              channel: '#dev-alerts',
              text: `ðŸš¨ Master Loop Error - Rollback initiated\nDeployment: ${items[0].json.deployment}\nErrors: ${items[0].json.monitoring.errors.join(', ')}`
            });

            // Retry Loop (max 3x)
            const retryCount = items[0].json.retry_count || 0;
            if (retryCount < 3) {
              return [{
                json: {
                  retry: true,
                  retry_count: retryCount + 1,
                  next: 'analyze'  // Gehe zurÃ¼ck zu Phase 1
                }
              }];
            }

            return [{
              json: {
                retry: false,
                status: 'FAILED_AFTER_3_ATTEMPTS'
              }
            }];

      false:
        - id: 7.2
          name: "Success Documentation"
          type: "function"
          code: |
            // Update Knowledge Base
            const successLog = `
## âœ… SUCCESS - ${new Date().toISOString()}
**Task:** ${items[0].json.task || 'Auto-Deploy'}
**Deployment:** ${items[0].json.deployment}
**Status:** All checks passed
**Monitoring:** No errors detected
`;

            await $node.helpers.writeFile(
              '/Users/jeremy/.claude/PROJECT_KNOWLEDGE.md',
              successLog,
              { append: true }
            );

            // Slack Notification
            await $node.helpers.call('slack', {
              channel: '#dev-success',
              text: `âœ… Master Loop Success\nDeployment: ${items[0].json.deployment}\nAll phases completed successfully!`
            });

            return [{
              json: {
                status: 'COMPLETED',
                message: 'All phases completed successfully'
              }
            }];

    # ==================== FINAL: NOTIFICATION ====================
    - id: 8
      name: "Final: Summary"
      type: "function"
      description: "Zusammenfassung senden"
      code: |
        const summary = {
          workflow: 'Claude Master Developer Loop',
          timestamp: new Date().toISOString(),
          phases_completed: 8,
          status: items[0].json.status || 'COMPLETED',
          monitoring: items[0].json.monitoring || null,
          report_location: '/Users/jeremy/.claude/MONITORING_REPORT.md'
        };

        // Send to Claude Code
        await $node.helpers.call('webhook', {
          url: 'https://api.claude-code.com/webhook',
          body: summary
        });

        return [{ json: summary }];

  # ==================== ERROR HANDLING ====================
  error_handling:
    on_error: "retry_with_backoff"
    max_retries: 3
    retry_delay: "exponential"  # 1min, 2min, 4min

    alerts:
      - type: "slack"
        channel: "#dev-alerts"
        conditions: ["build_failed", "deploy_failed", "monitoring_errors"]

      - type: "email"
        to: "jeremy@example.com"
        conditions: ["critical_error", "rollback_initiated"]

  # ==================== SCHEDULES ====================
  schedules:
    # Daily Health Check
    - name: "Daily Health Check"
      cron: "0 9 * * *"  # 9 AM daily
      trigger: "health_check"

    # Weekly Research Update
    - name: "Weekly Research"
      cron: "0 10 * * 1"  # Monday 10 AM
      trigger: "research_update"

    # Auto-Deploy on Git Push
    - name: "Git Push Listener"
      trigger: "github_webhook"
      event: "push:main"

  # ==================== OUTPUT FILES ====================
  output_files:
    research_log: "/Users/jeremy/.claude/RESEARCH_LOG.md"
    task_queue: "/Users/jeremy/.claude/TASK_QUEUE.yaml"
    monitoring_report: "/Users/jeremy/.claude/MONITORING_REPORT.md"
    knowledge_base: "/Users/jeremy/.claude/PROJECT_KNOWLEDGE.md"
    error_solutions: "/Users/jeremy/.claude/ERROR_SOLUTIONS.md"

  # ==================== MCP CONFIGURATION ====================
  mcp_servers:
    - name: "serena"
      command: "npx"
      args: ["-y", "@anthropics/serena-mcp"]
      description: "Code Analysis & Architecture"

    - name: "skyvern"
      command: "python"
      args: ["-m", "skyvern.mcp.server"]
      description: "Browser Automation & Monitoring"

    - name: "context7"
      command: "npx"
      args: ["-y", "@anthropics/context7-mcp"]
      description: "Documentation & Examples"

  # ==================== METRICS & LOGGING ====================
  metrics:
    track:
      - task_completion_rate
      - error_detection_time
      - deployment_success_rate
      - auto_fix_rate
      - documentation_coverage

    log_to: "/Users/jeremy/.claude/METRICS_LOG.md"
    retention_days: 90

---
# ðŸ“š HOW TO USE
#
# 1. Import in n8n:
#    - Go to n8n Dashboard
#    - Workflows â†’ Import
#    - Select this YAML file
#
# 2. Configure MCP Servers:
#    - Update paths in mcp_servers section
#    - Test connections
#
# 3. Set up Webhooks:
#    - Configure Claude Code to call /api/claude/master-loop
#    - Or use manual trigger
#
# 4. Start Workflow:
#    - Activate workflow
#    - Monitor in n8n Dashboard
#
# 5. View Results:
#    - Check ~/.claude/MONITORING_REPORT.md
#    - Check ~/.claude/TASK_QUEUE.yaml
#    - Check Slack #dev-success channel
#
# ðŸš€ Ready to use!
