name: ðŸš€ Branch Management & Auto-Merge 2026

on:
  # Trigger on push to main
  push:
    branches: [main]

  # Trigger on PR creation/update
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

  # Scheduled cleanup (weekly)
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

  # Manual trigger
  workflow_dispatch:

jobs:
  # ========================================
  # ðŸ“Š Branch Status Check
  # ========================================
  branch-status:
    runs-on: ubuntu-latest
    outputs:
      has-ahead-branches: ${{ steps.check.outputs.has-ahead }}
      ahead-count: ${{ steps.check.outputs.ahead-count }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check Branch Status
        id: check
        run: |
          echo "=== Checking all branches for ahead/behind status ==="

          # Get branches ahead of remote
          AHEAD_BRANCHES=$(git branch -vv | grep "\[origin.*ahead" || true)
          AHEAD_COUNT=$(echo "$AHEAD_BRANCHES" | grep -c "ahead" || echo "0")

          if [ "$AHEAD_COUNT" -gt "0" ]; then
            echo "has-ahead=true" >> $GITHUB_OUTPUT
            echo "ahead-count=$AHEAD_COUNT" >> $GITHUB_OUTPUT
            echo "âŒ Found $AHEAD_COUNT branches ahead of remote:"
            echo "$AHEAD_BRANCHES"
          else
            echo "has-ahead=false" >> $GITHUB_OUTPUT
            echo "ahead-count=0" >> $GITHUB_OUTPUT
            echo "âœ… All branches are synced"
          fi

      - name: ðŸ“‹ List All Branches
        run: |
          echo "=== Current Branch Status ==="
          git branch -vv

  # ========================================
  # ðŸ”„ Auto-Merge Ready PRs
  # ========================================
  auto-merge:
    runs-on: ubuntu-latest
    needs: branch-status
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¤– Auto-Merge if Ready
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "auto-merge: {{pullRequest.title}}"
          MERGE_FORK: "false"
          UPDATE_METHOD: "rebase"

  # ========================================
  # ðŸ§¹ Cleanup Merged Branches
  # ========================================
  cleanup-branches:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ðŸ§¹ Delete Merged Branches
        run: |
          echo "=== Deleting merged branches ==="

          # Fetch all branches
          git fetch --prune

          # Get list of branches that are merged into main
          MERGED_BRANCHES=$(git branch --merged main | grep -v "^\*\|main" | grep "DeepthinkAI2025/" || true)

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "âœ… No merged branches to delete"
            exit 0
          fi

          echo "Found merged branches:"
          echo "$MERGED_BRANCHES"

          # Delete local branches
          echo "$MERGED_BRANCHES" | while read branch; do
            if [ -n "$branch" ]; then
              echo "Deleting local branch: $branch"
              git branch -d "$branch" || echo "Failed to delete $branch"
            fi
          done

      - name: ðŸ“¤ Push Branch Deletions
        run: |
          echo "=== Pushing branch deletions to remote ==="
          git push origin --delete $(git branch -r | grep "DeepthinkAI2025/" | grep -v "HEAD" | sed 's/origin\///' || true) 2>/dev/null || echo "No remote branches to delete"

  # ========================================
  # ðŸ“Š Sync All Branches
  # ========================================
  sync-all-branches:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ðŸ”„ Sync All Branches
        run: |
          echo "=== Syncing all branches to main ==="

          # Get all feature branches
          BRANCHES=$(git branch --list "DeepthinkAI2025/*" | grep -v "main" || true)

          if [ -z "$BRANCHES" ]; then
            echo "No branches to sync"
            exit 0
          fi

          for branch in $BRANCHES; do
            echo ""
            echo "Processing: $branch"

            # Check if branch exists on remote
            if git ls-remote --exit-code origin "$branch" >/dev/null 2>&1; then
              echo "  âœ… Branch exists on remote"

              # Check if ahead/behind
              BEHIND=$(git rev-list --count origin/"$branch".."$branch" 2>/dev/null || echo "0")
              AHEAD=$(git rev-list --count "$branch"..origin/"$branch" 2>/dev/null || echo "0")

              if [ "$BEHIND" -gt "0" ]; then
                echo "  ðŸ“¤ Pushing $BEHIND commits..."
                git push origin "$branch" || echo "  âŒ Push failed"
              elif [ "$AHEAD" -gt "0" ]; then
                echo "  ðŸ“¥ Pulling $AHEAD commits..."
                git pull origin "$branch" || echo "  âŒ Pull failed"
              else
                echo "  âœ… Already synced"
              fi
            else
              echo "  ðŸ†• New branch, pushing to remote..."
              git push -u origin "$branch" || echo "  âŒ Initial push failed"
            fi
          done

  # ========================================
  # ðŸŽ¯ PR Status Report
  # ========================================
  status-report:
    runs-on: ubuntu-latest
    needs: [branch-status]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š Generate Status Report
        run: |
          echo "=== ðŸ“‹ BRANCH MANAGEMENT STATUS REPORT ==="
          echo ""
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""

          echo "## ðŸ“Š Current Branch Status"
          echo ""
          echo "```bash"
          git branch -vv | head -20
          echo "```"
          echo ""

          echo "## ðŸŽ¯ Open Pull Requests"
          echo ""
          gh pr list --state open --json number,title,author,status,mergeable --template \
            '{{range .}}{{.number}} | {{.title}} | {{.author.login}} | {{.status}} | {{.mergeable}}
{{end}}' 2>/dev/null || echo "No PRs or gh CLI not available"
          echo ""

          echo "## ðŸš€ Recent Activity"
          echo ""
          git log --oneline -10 --graph --decorate
          echo ""

          echo "## âœ… Summary"
          echo "- Total branches: $(git branch --list | wc -l)"
          echo "- Remote branches: $(git branch -r | grep -v HEAD | wc -l)"
          echo "- Open PRs: $(gh pr list --state open --json number 2>/dev/null | jq length 2>/dev/null || echo "N/A")"

      - name: ðŸ’¬ Post Report to Slack (Optional)
        if: false  # Enable if you have Slack webhook
        run: |
          echo "Posting report to Slack..."
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Branch Management Report"}' \
          #   ${{ secrets.SLACK_WEBHOOK }}
