# Story L2 — ELSTER UStVA XML Export für manuelle Übermittlung (je Monat/Quartal)

## Status: ✅ IMPLEMENTIERT

Implementiert in Sprint 10. XML-Export ist funktionsfähig und kann für manuelle Übermittlung im ELSTER Online Portal verwendet werden.

## Beschreibung

Als Nutzer:in möchte ich für die Umsatzsteuervoranmeldung (UStVA) je Zeitraum (Monat/Quartal) eine **ELSTER-kompatible XML-Datei** erzeugen können, die ich manuell im ELSTER Online Portal hochladen kann, um eine elektronische Übermittlung zu ermöglichen.

## Hintergrund / Recherche-Notizen (Stand: 2025-12-14)

- Ein reiner „XML-Upload" in Mein ELSTER ist möglich und wird vom ELSTER Online Portal unterstützt.
- Historisch gab es eine „offene Schnittstelle" (ElsterAnmeldung/XML), die für UStVA/LStA serverseitig abgeschaltet wurde (Quelle: Projektbeschreibung/README von Geierlein, einem früheren ELSTER-Client).
- Für eine **korrekte** elektronische Übermittlung wird in der Praxis **ERiC (Elster Rich Client)** bzw. eine Hersteller-Schnittstelle benötigt (inkl. Zertifikat/Signatur/Transport).
- **Recherche-Ergebnis:** Keine öffentlichen/legalen Quellen für ERiC-Binaries gefunden. Daher Fallback auf XML-Export für manuelle Übermittlung via ELSTER Online Portal.

Konsequenz: In einer reinen Browser-SPA (Vite/React ohne Backend) wird ein ELSTER-kompatibles XML für manuellen Upload im ELSTER Online Portal bereitgestellt.

## Akzeptanzkriterien

- ✅ Es existiert ein Export-Button in der UStVA-Ansicht: „XML Export".
- ✅ Zeitraum wird eindeutig abgebildet:
  - Monat: `YYYY-MM`
  - Quartal: `YYYY-Qn`
- ✅ Export basiert auf bestehenden Berechnungen (UStVA-Auswertung) und den ELSTER-Stammdaten aus Settings.
- ✅ Export erzeugt ELSTER-kompatibles XML für manuellen Upload im ELSTER Online Portal.
- ✅ Klare Anweisungen zur Nutzung des Exports werden in der UI angezeigt.

## Implementation Details

- **Neuer Service:** `services/elsterExport.ts` - Generiert ELSTER-kompatibles XML im Coala-Format
- **UI Integration:** XML-Export-Button in UStVA-Ansicht und Toolbar (nur bei UStVA-View)
- **XML Format:** ElsterAnmeldung v8 mit Umsatzsteuervoranmeldung-Daten
- **Zeitraum-Logik:** Automatische Erkennung von Quartal (Q1-Q4) vs. Monat (01-12)
- **Validierung:** Prüfung auf vorhandene ELSTER-Stammdaten vor Export

## Out of Scope

- Vollständige ELSTER-Online-Submission inkl. Zertifikatsverwaltung im Browser, wenn dafür keine sichere/tragfähige Lösung existiert.

## Touchpoints

- UI: components/DatabaseGrid.tsx (UStVA View + Export Action)
- Settings: components/SettingsView.tsx, services/storageService.ts, types.ts
- Neu: services/elsterExport.ts (XML-Generierung)

## Offene Entscheidungen

- XML-Schema-Version für ELSTER UStVA (aktuell: ElsterAnmeldung v8, Umsatzsteuervoranmeldung)
- Unterstützung weiterer ELSTER-Formulare (z.B. Umsatzsteuerjahreserklärung)

## Test-Hinweise

- `npm run check` bleibt grün.
- Manuell: Export erzeugen, Zeitraum im Dateinamen prüfen, Inhalte plausibel (Kennzahlen/Values).
- XML-Datei sollte im ELSTER Online Portal akzeptiert werden (ohne Signaturprüfung).
